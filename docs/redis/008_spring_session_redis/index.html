<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="tech blog 글 읽고 정리하기 # 제목은 Spring Session 도입기로 하겠습니다. 근데 이제 Redis를 곁들인 # 개요 # 줌인터넷의 회원 서비스는 분산 환경에서 운영되고있다. 분산 환경에서 세션 동기화 문제를 해결하기 위해 사용하고 있는 세션 저장소를 Redis로 교체하게 된 이유와 기존 아키텍처를 유지하면서 안정적으로 Spring Session으로 도입할 수 있는 방법을 소개한다.
도입 배경 # 기존 Aerospike -&gt; Redis로의 전환을 결정하게 되었다. 전환을 통해 바라는 점
Spring Session의 도입 가능 Spring Session은 Redis 이외에도 다양한 세션 저장소를 지원하여 세션 정보를 유연하게 관리할 수 있다.">
<meta name="theme-color" media="(prefers-color-scheme: light)" content="#ffffff">
<meta name="theme-color" media="(prefers-color-scheme: dark)" content="#343a40">
<meta name="color-scheme" content="light dark"><meta property="og:title" content="" />
<meta property="og:description" content="tech blog 글 읽고 정리하기 # 제목은 Spring Session 도입기로 하겠습니다. 근데 이제 Redis를 곁들인 # 개요 # 줌인터넷의 회원 서비스는 분산 환경에서 운영되고있다. 분산 환경에서 세션 동기화 문제를 해결하기 위해 사용하고 있는 세션 저장소를 Redis로 교체하게 된 이유와 기존 아키텍처를 유지하면서 안정적으로 Spring Session으로 도입할 수 있는 방법을 소개한다.
도입 배경 # 기존 Aerospike -&gt; Redis로의 전환을 결정하게 되었다. 전환을 통해 바라는 점
Spring Session의 도입 가능 Spring Session은 Redis 이외에도 다양한 세션 저장소를 지원하여 세션 정보를 유연하게 관리할 수 있다." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://example.com/docs/redis/008_spring_session_redis/" /><meta property="article:section" content="docs" />
<meta property="article:published_time" content="2023-12-25T00:00:00+00:00" />
<meta property="article:modified_time" content="2023-12-26T00:04:38+09:00" />

<title>008 Spring Session Redis | TIL</title>
<link rel="manifest" href="/manifest.json">
<link rel="icon" href="/favicon.png" >
<link rel="stylesheet" href="/book.min.4f0117e74e5337280f18eb9641eae520cb4b25adcf5dd64fafad4664145a5957.css" integrity="sha256-TwEX505TNygPGOuWQerlIMtLJa3PXdZPr61GZBRaWVc=" crossorigin="anonymous">
  <script defer src="/flexsearch.min.js"></script>
  <script defer src="/en.search.min.6329777308d375abcf34f66d8a63567dda2fff082d525da057506c4b8f50a2fc.js" integrity="sha256-Yyl3cwjTdavPNPZtimNWfdov/wgtUl2gV1BsS49Qovw=" crossorigin="anonymous"></script>

  <script defer src="/sw.min.6f6f90fcb8eb1c49ec389838e6b801d0de19430b8e516902f8d75c3c8bd98739.js" integrity="sha256-b2&#43;Q/LjrHEnsOJg45rgB0N4ZQwuOUWkC&#43;NdcPIvZhzk=" crossorigin="anonymous"></script>
<!--
Made with Book Theme
https://github.com/alex-shpak/hugo-book
-->
  
</head>
<body dir="ltr">
  <input type="checkbox" class="hidden toggle" id="menu-control" />
  <input type="checkbox" class="hidden toggle" id="toc-control" />
  <main class="container flex">
    <aside class="book-menu">
      <div class="book-menu-content">
        
  <nav>
<h2 class="book-brand">
  <a class="flex align-center" href="/"><span>TIL</span>
  </a>
</h2>


<div class="book-search">
  <input type="text" id="book-search-input" placeholder="Search" aria-label="Search" maxlength="64" data-hotkeys="s/" />
  <div class="book-search-spinner hidden"></div>
  <ul id="book-search-results"></ul>
</div>












  



  
  <ul>
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-353f7a5578fa41dbc42c73ea30fe2255" class="toggle"  />
    <label for="section-353f7a5578fa41dbc42c73ea30fe2255" class="flex justify-between">
      <a href="/docs/algorithm/" class="">Algorithm</a>
    </label>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-92d85911959de2466ef66b3821f607d7" class="toggle"  />
    <label for="section-92d85911959de2466ef66b3821f607d7" class="flex justify-between">
      <a href="/docs/batch/" class="">Batch</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/batch/002_batch_performance/" class="">002 Batch Performance</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/batch/001_performance_improved_batch/" class="">001 Performance Improved Batch</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-17728c6c6bedfdb3d8e5f42b88c6a9db" class="toggle"  />
    <label for="section-17728c6c6bedfdb3d8e5f42b88c6a9db" class="flex justify-between">
      <a href="/docs/clean_code/" class="">Clean Code</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/clean_code/001_argument/" class="">001 Argument</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-7cc6bc3da96a6c77d5e4cc0966a5e312" class="toggle"  />
    <label for="section-7cc6bc3da96a6c77d5e4cc0966a5e312" class="flex justify-between">
      <a href="/docs/data_structure/" class="">Data Structure</a>
    </label>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-f63d6cf864a4b2a00c9bc1b7f8921b37" class="toggle"  />
    <label for="section-f63d6cf864a4b2a00c9bc1b7f8921b37" class="flex justify-between">
      <a href="/docs/ddd/" class="">Ddd</a>
    </label>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-10d41b0387e5bda7e9958b9b5ece051e" class="toggle"  />
    <label for="section-10d41b0387e5bda7e9958b9b5ece051e" class="flex justify-between">
      <a href="/docs/docker/" class="">Docker</a>
    </label>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-ba0b1465c1bad5a998860ad5f870bf7e" class="toggle"  />
    <label for="section-ba0b1465c1bad5a998860ad5f870bf7e" class="flex justify-between">
      <a href="/docs/etc/" class="">Etc</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/etc/001_jmeter/" class="">001 Jmeter</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-eca69da21de5b0cd25d8421dec09a327" class="toggle"  />
    <label for="section-eca69da21de5b0cd25d8421dec09a327" class="flex justify-between">
      <a href="/docs/java/" class="">Java</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/java/001_facade_pattern/" class="">001 Facade Pattern</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-f3c1d22d19edbcf158d04b84a4d9d6c2" class="toggle"  />
    <label for="section-f3c1d22d19edbcf158d04b84a4d9d6c2" class="flex justify-between">
      <a href="/docs/jenkins/" class="">Jenkins</a>
    </label>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-55218fb7ef47d61aa86fc77253026243" class="toggle"  />
    <label for="section-55218fb7ef47d61aa86fc77253026243" class="flex justify-between">
      <a href="/docs/jpa/" class="">Jpa</a>
    </label>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-c03dced0c5b16cbce767a51b81ce1077" class="toggle"  />
    <label for="section-c03dced0c5b16cbce767a51b81ce1077" class="flex justify-between">
      <a href="/docs/kafka/" class="">Kafka</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/kafka/001_kafka_cdc/" class="">001 Kafka Cdc</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-04d541b0249994115320e926dbc9d6c5" class="toggle"  />
    <label for="section-04d541b0249994115320e926dbc9d6c5" class="flex justify-between">
      <a href="/docs/kotlin/" class="">Kotlin</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/kotlin/005_Kotlin_extractList_Method/" class="">005 Kotlin Extract List Method</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/kotlin/004_Kotlin_Scoping_Functions/" class="">004 Kotlin Scoping Functions</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/kotlin/003_Kotlin_basic/" class="">003 Kotlin Basic</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/kotlin/002_Functional_Programming_Example/" class="">002 Functional Programming Example</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/kotlin/001_Functional_Programming/" class="">001 Functional Programming</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-6ae1a891fb3a3f71d71273fc61b29b76" class="toggle"  />
    <label for="section-6ae1a891fb3a3f71d71273fc61b29b76" class="flex justify-between">
      <a href="/docs/linux/" class="">Linux</a>
    </label>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-b16ff4658c272fcaa2c58683b4c10070" class="toggle"  />
    <label for="section-b16ff4658c272fcaa2c58683b4c10070" class="flex justify-between">
      <a href="/docs/mongodb/" class="">Mongodb</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/mongodb/003_spring_data_mongodb/" class="">003 Spring Data Mongodb</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/mongodb/004_object_mapping/" class="">004 Object Mapping</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/mongodb/005_mongoOperations/" class="">005 Mongo Operations</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/mongodb/006_reactiveMongoRepository/" class="">006 Reactive Mongo Repository</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/mongodb/007_query_method/" class="">007 Query Method</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/mongodb/001_reactive_mongodb/" class="">001 Reactive Mongodb</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/mongodb/002_mongodb_document/" class="">002 Mongodb Document</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-5e9a5c8a0cadf7504bcc8a3083d0b6fb" class="toggle"  />
    <label for="section-5e9a5c8a0cadf7504bcc8a3083d0b6fb" class="flex justify-between">
      <a href="/docs/msa/" class="">Msa</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/msa/003_circuit_breaker/" class="">003 Circuit Breaker</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/msa/001_reactive/" class="">001 Reactive</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/msa/002_reactive_microservice/" class="">002 Reactive Microservice</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-6d933f523f0d56e111956755e38e3f44" class="toggle"  />
    <label for="section-6d933f523f0d56e111956755e38e3f44" class="flex justify-between">
      <a href="/docs/mvc/" class="">Mvc</a>
    </label>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-e66e2e478c81786f553bd82d3931b216" class="toggle"  />
    <label for="section-e66e2e478c81786f553bd82d3931b216" class="flex justify-between">
      <a href="/docs/mysql/" class="">Mysql</a>
    </label>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-3110560962cac834dcd3aead95e804a4" class="toggle"  />
    <label for="section-3110560962cac834dcd3aead95e804a4" class="flex justify-between">
      <a href="/docs/network/" class="">Network</a>
    </label>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-bbe16af0cda0a52165d4874f0cea4ee0" class="toggle"  />
    <label for="section-bbe16af0cda0a52165d4874f0cea4ee0" class="flex justify-between">
      <a href="/docs/operating_system/" class="">Operating System</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/operating_system/001_thread/" class="">001 Thread</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-bf2e8ecdf9011d9f48a2a3a2c2d46bd1" class="toggle"  />
    <label for="section-bf2e8ecdf9011d9f48a2a3a2c2d46bd1" class="flex justify-between">
      <a href="/docs/oracle/" class="">Oracle</a>
    </label>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-2aa56d1b653c397446719c79393a70da" class="toggle"  />
    <label for="section-2aa56d1b653c397446719c79393a70da" class="flex justify-between">
      <a href="/docs/parallel_programming/" class="">Parallel Programming</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/parallel_programming/001_process_thread/" class="">001 Process Thread</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/parallel_programming/002_parallel_concurrent/" class="">002 Parallel Concurrent</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-708c7a6270d696606cabeb20f951886f" class="toggle"  />
    <label for="section-708c7a6270d696606cabeb20f951886f" class="flex justify-between">
      <a href="/docs/r2dbc/" class="">R2dbc</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/r2dbc/005_r2dbc_Metadata_mapping/" class="">005 R2dbc Metadata Mapping</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/r2dbc/006_r2dbcEntityOperations/" class="">006 R2dbc Entity Operations</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/r2dbc/007_r2dbcRepository/" class="">007 R2dbc Repository</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/r2dbc/008_r2dbc_query_method/" class="">008 R2dbc Query Method</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/r2dbc/003_r2dbcEntityTemplate/" class="">003 R2dbc Entity Template</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/r2dbc/004_r2dbc_object_mapping/" class="">004 R2dbc Object Mapping</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/r2dbc/002_r2dbc_mysql/" class="">002 R2dbc Mysql</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/r2dbc/001_r2dbc_intro/" class="">001 R2dbc Intro</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-c1a35f6db1170c97addf30f5d9f50bc9" class="toggle"  />
    <label for="section-c1a35f6db1170c97addf30f5d9f50bc9" class="flex justify-between">
      <a href="/docs/rdbms/" class="">Rdbms</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/rdbms/004_window_function/" class="">004 Window Function</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/rdbms/005_subquery/" class="">005 Subquery</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/rdbms/001_basic_join/" class="">001 Basic Join</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/rdbms/002_date_interval/" class="">002 Date Interval</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/rdbms/003_groupby/" class="">003 Groupby</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-a396ef4e072acbb7275e447dad1284d6" class="toggle"  />
    <label for="section-a396ef4e072acbb7275e447dad1284d6" class="flex justify-between">
      <a href="/docs/reactive_streams/" class="">Reactive Streams</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/reactive_streams/002_impl1_reactor/" class="">002 Impl1 Reactor</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/reactive_streams/003_impl2_rxjava/" class="">003 Impl2 Rxjava</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/reactive_streams/004_impl3_munity/" class="">004 Impl3 Munity</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/reactive_streams/001_reactive_streams_component/" class="">001 Reactive Streams Component</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-a27d7ef673b519721b4909eba7547282" class="toggle" checked />
    <label for="section-a27d7ef673b519721b4909eba7547282" class="flex justify-between">
      <a href="/docs/redis/" class="">Redis</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/redis/008_spring_session_redis/" class="active">008 Spring Session Redis</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/redis/007_redis_cluster_migration/" class="">007 Redis Cluster Migration</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/redis/003_reactive_redis_intro/" class="">003 Reactive Redis Intro</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/redis/004_Lettuce/" class="">004 Lettuce</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/redis/005_ReactiveRedisTemplate/" class="">005 Reactive Redis Template</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/redis/006_ReactiveOperations/" class="">006 Reactive Operations</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/redis/001_redis_datastructure/" class="">001 Redis Datastructure</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/redis/002_redis_cache/" class="">002 Redis Cache</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-6ce8ef21c020ccdb7ed73156795b30be" class="toggle"  />
    <label for="section-6ce8ef21c020ccdb7ed73156795b30be" class="flex justify-between">
      <a href="/docs/security/" class="">Security</a>
    </label>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-4442d34d5ae489970dcda30dcfc7289e" class="toggle"  />
    <label for="section-4442d34d5ae489970dcda30dcfc7289e" class="flex justify-between">
      <a href="/docs/servlet/" class="">Servlet</a>
    </label>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-12bece9beab0746d531536027bb6a777" class="toggle"  />
    <label for="section-12bece9beab0746d531536027bb6a777" class="flex justify-between">
      <a href="/docs/spring/" class="">Spring</a>
    </label>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-5f1e4c3c9f29fee9a25ac2c5291c7472" class="toggle"  />
    <label for="section-5f1e4c3c9f29fee9a25ac2c5291c7472" class="flex justify-between">
      <a href="/docs/webflux/" class="">Webflux</a>
    </label>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>











  
<ul>
  
  <li>
    <a href="/posts/"  >
        Categories and tags
      </a>
  </li>
  
  <li>
    <a href="https://github.com/seohaebada"  target="_blank" rel="noopener">
        Github
      </a>
  </li>
  
  <li>
    <a href="https://devfunny.tistory.com"  target="_blank" rel="noopener">
        Blog
      </a>
  </li>
  
</ul>






</nav>




  <script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script>


 
      </div>
    </aside>

    <div class="book-page">
      <header class="book-header">
        
  <div class="flex align-center justify-between">
  <label for="menu-control">
    <img src="/svg/menu.svg" class="book-icon" alt="Menu" />
  </label>

  <strong>008 Spring Session Redis</strong>

  <label for="toc-control">
    
    <img src="/svg/toc.svg" class="book-icon" alt="Table of Contents" />
    
  </label>
</div>


  
  <aside class="hidden clearfix">
    
  
<nav id="TableOfContents">
  <ul>
    <li><a href="#tech-blog-글-읽고-정리하기"><code>tech blog 글 읽고 정리하기</code></a></li>
    <li><a href="#제목은-spring-session-도입기로-하겠습니다-근데-이제-redis를-곁들인">제목은 Spring Session 도입기로 하겠습니다. 근데 이제 Redis를 곁들인</a>
      <ul>
        <li><a href="#개요">개요</a></li>
        <li><a href="#도입-배경">도입 배경</a></li>
        <li><a href="#spring-session">Spring Session</a></li>
        <li><a href="#spring-session-적용-예시">Spring Session 적용 예시</a></li>
        <li><a href="#아키텍처">아키텍처</a></li>
        <li><a href="#코드로-살펴보는-개선-과정">코드로 살펴보는 개선 과정</a>
          <ul>
            <li></li>
          </ul>
        </li>
        <li><a href="#마무리---확인">마무리 - 확인</a></li>
      </ul>
    </li>
  </ul>
</nav>



  </aside>
  
 
      </header>

      
      
  <article class="markdown book-article"><h1 id="tech-blog-글-읽고-정리하기">
  <code>tech blog 글 읽고 정리하기</code>
  <a class="anchor" href="#tech-blog-%ea%b8%80-%ec%9d%bd%ea%b3%a0-%ec%a0%95%eb%a6%ac%ed%95%98%ea%b8%b0">#</a>
</h1>
<h1 id="제목은-spring-session-도입기로-하겠습니다-근데-이제-redis를-곁들인">
  제목은 Spring Session 도입기로 하겠습니다. 근데 이제 Redis를 곁들인
  <a class="anchor" href="#%ec%a0%9c%eb%aa%a9%ec%9d%80-spring-session-%eb%8f%84%ec%9e%85%ea%b8%b0%eb%a1%9c-%ed%95%98%ea%b2%a0%ec%8a%b5%eb%8b%88%eb%8b%a4-%ea%b7%bc%eb%8d%b0-%ec%9d%b4%ec%a0%9c-redis%eb%a5%bc-%ea%b3%81%eb%93%a4%ec%9d%b8">#</a>
</h1>
<h2 id="개요">
  개요
  <a class="anchor" href="#%ea%b0%9c%ec%9a%94">#</a>
</h2>
<p>줌인터넷의 회원 서비스는 분산 환경에서 운영되고있다.
분산 환경에서 세션 동기화 문제를 해결하기 위해 사용하고 있는 세션 저장소를 Redis로 교체하게 된 이유와
기존 아키텍처를 유지하면서 안정적으로 Spring Session으로 도입할 수 있는 방법을 소개한다.</p>
<h2 id="도입-배경">
  도입 배경
  <a class="anchor" href="#%eb%8f%84%ec%9e%85-%eb%b0%b0%ea%b2%bd">#</a>
</h2>
<p>기존 Aerospike -&gt; Redis로의 전환을 결정하게 되었다.
전환을 통해 바라는 점</p>
<ol>
<li>
<p>Spring Session의 도입 가능
Spring Session은 Redis 이외에도 다양한 세션 저장소를 지원하여 세션 정보를 유연하게 관리할 수 있다.
다음에 세션 저장소를 변경해야할 경우에도 유연성을 제공한다.</p>
</li>
<li>
<p>유지보수 용이성 향상
팀 내에 이미 사용중이며, 신규 인프라 구축 비용이 발생하지 않는다.
Aerospike 관련 레퍼런스가 부족하여 러닝 커브가 큰 점을 고려할때 Redis로 전환하게되면 학습에서 발생하는 리소스 비용을 줄일 수 있다.</p>
</li>
</ol>
<p>위와 같은 이유로 세션 저장소를 Aerospike에서 Redis로 전환하면서 Spring Session을 도입하게 되었다.</p>
<h2 id="spring-session">
  Spring Session
  <a class="anchor" href="#spring-session">#</a>
</h2>
<p>스프링 기반 애플리케이션에서 세션 관리를 효과적으로 처리하기 위한 기술이다.
기본적으로 스프링 세션은 세션 데이터를 서버의 메모리에 저장하는 대신 외부 스토리지에 저장하고 관리한다.
Spring Session은 세션 데이터를 외부 스토리지에 저장함으로써 여러 서버 간에 세션 데이터를 공유하고 로드밸런싱과 확장성을 지원한다.
이는 분산 환경에서 여러 서버가 같은 세션 데이터를 접근하고 처리할 수 있도록 해주는 장점을 제공한다.</p>
<p>Spring Session은 사용자의 세션 정보를 관리하기 위해 API 및 구현체를 제공한다.</p>
<ul>
<li>springSessionRepositoryFilter (Filter 인터페이스를 구현한 빈)
서블릿 컨테이너는 모든 요청에 대해 <code>springSessionRepositoryFilter</code>를 사용하도록 설정해야 하지만, 이 과정은 Spring Boot가 자동으로 처리해준다.</li>
</ul>
<h2 id="spring-session-적용-예시">
  Spring Session 적용 예시
  <a class="anchor" href="#spring-session-%ec%a0%81%ec%9a%a9-%ec%98%88%ec%8b%9c">#</a>
</h2>
<blockquote>
<p>build.gradle</p>
</blockquote>
<pre tabindex="0"><code>dependencies {
    // Spring Boot에서 Redis를 사용하기 위한 의존성입니다. 
    implementation &#39;org.springframework.boot:spring-boot-starter-data-redis&#39;
    // Spring Session을 Redis에 저장하기 위한 의존성입니다.
    implementation &#39;org.springframework.session:spring-session-data-redis&#39;
}
</code></pre><blockquote>
<p>application.yml</p>
</blockquote>
<pre tabindex="0"><code>server:
  servlet:
    session:
      cookie:
        path: / # 적용될 URL 경로를 나타냅니다. 예를 들어, path를 &#34;/&#34;로 설정하면 해당 도메인의 모든 경로에서 쿠키가 사용될 수 있습니다.
        name: JSESSIONID # 이름을 지정합니다.
        domain: zum.com # 유효 도메인을 지정합니다. 예를 들어, domain을 &#34;zum.com&#34;으로 설정하면 해당 도메인과 그 서브도메인에서 쿠키가 유효합니다.
        http-only: true # 브라우저에서 해당 쿠키에 대한 JavaScript 접근을 제한합니다. 이를 통해 XSS 공격을 방지할 수 있습니다.
        secure: true # 쿠키가 HTTPS(SSL/TLS) 연결을 통해서만 전송되어야 함을 나타냅니다. 즉, HTTPS로 암호화된 연결에서만 쿠키가 전송되어야 합니다.
      timeout: 3600 # 세션의 유효 시간을 지정합니다. 단위는 초입니다.

spring:
  redis:
    host: 127.0.0.1
    port: 6379
    password:
  session:
    store-type: redis # 세션 저장소를 지정합니다.
    redis:
      namespace: zum:session # 세션을 저장하는 데 사용되는 키의 네임스페이스를 지정합니다.
</code></pre><p>server.servlet.session.cookie를 통해 쿠키의 속성을 지정할 수 있다.
spring.session.store-type을 지정해주면 별도의 설정 없이 Spring Boot의 AutoConfiguration으로 인해 @EnableRedisHttpSession 을 추가한 것과 같다.
또한 Spring Boot는 spring.session.store-type 속성을 기반으로 실제 사용할 구현체를 결정한다.
기본적으로 인메모리 저장소인 MapSessionRepository 클래스가 적용된다.
예를 들어, Redis를 사용하려는 경우 Redis 세션 저장소 구현체인 RedisIndexedSessionRepository 클래스가 Bean으로 등록된다.

  <img src="/image/redis/008/img.png" alt="img.png" /></p>
<h2 id="아키텍처">
  아키텍처
  <a class="anchor" href="#%ec%95%84%ed%82%a4%ed%85%8d%ec%b2%98">#</a>
</h2>
<blockquote>
<p>AS-IS

  <img src="/image/redis/008/img_1.png" alt="img_1.png" />

  <img src="/image/redis/008/img_2.png" alt="img_2.png" /></p>
</blockquote>
<p>회원 서비스는 위와 같이 각 모듈을 독립적으로 서버에 배포하여 운영하고 있다.
기존 아키텍처에서는 모듈마다 같은 ID Generator를 사용하여 세션 아이디를 생성하고 있다.
생성된 세션 아이디를 통해 각 모듈은 세션 서버에 요청하여 세션 저장소에 접근한다.
이렇게 각 모듈마다 ID Generator가 존재하는 경우 만약 세션 아이디 생성 전략이 변경되었다면, 변경된 전략을 적용하기 위해 각 모듈을 전부 재배포해야한다.
또한 새로운 모듈이 추가된다면 매번 ID Generator를 추가해야한다.
매우 낮은 확률이지만 중복된 세션 아이디가 생성될 수 있다는 가능성도 고려했다.</p>
<blockquote>
<p>TO-BE

  <img src="/image/redis/008/img_3.png" alt="img_3.png" />

  <img src="/image/redis/008/img_4.png" alt="img_4.png" /></p>
</blockquote>
<p>세션 아이디 생성 전략을 담당하는 ID Generator를 하나의 모듈에서 관리하도록 변경했다.</p>
<ol>
<li>사용자가 각 모듈에 접근합니다.</li>
<li>각 모듈은 세션 서버에 세션 아이디를 요청합니다.</li>
<li>세션 서버는 세션 아이디를 발행하고 세션 아이디와 함께 응답합니다.</li>
<li>각 모듈은 발급받은 세션 아이디를 클라이언트에 전송합니다.</li>
</ol>
<p>와 같이 ID Generator를 한 곳에서 관리하면 모듈 간 응집도가 높아지며,
필요한 변경이 있을 때도 해당 모듈만 수정하여 유지보수와 서비스의 확장을 유연하게 할수있다.
ID Generator를 하나의 모듈에서 관리하고, Redis를 통해 세션 정보를 관리하도록 변경하여, 아키텍처를 개선하고, 중복 코드를 제거할 수 있다.</p>
<p>하지만 ID Generator를 한 곳에서 관리되기 때문에 <code>SPOF(Single Point of Failure)</code>가 발생할 수 있다.
SPOF란 시스템에서 단일 실패 지점으로, 해당 지점에 장애가 발생하면 전체 시스템이 영향을 받는 상황이다.
이러한 문제를 해결하기 위해 세션 서버의 인스턴스를 분산하여 구성하였다.</p>
<h2 id="코드로-살펴보는-개선-과정">
  코드로 살펴보는 개선 과정
  <a class="anchor" href="#%ec%bd%94%eb%93%9c%eb%a1%9c-%ec%82%b4%ed%8e%b4%eb%b3%b4%eb%8a%94-%ea%b0%9c%ec%84%a0-%ea%b3%bc%ec%a0%95">#</a>
</h2>
<blockquote>
<p>프로젝트 환경</p>
</blockquote>
<ul>
<li>Java 8</li>
<li>Spring Boot 2.x</li>
<li>Spring Security 5.x</li>
</ul>
<blockquote>
<p>AS-IS
기존 아키텍처에서 사용자가 요청 시 세션 아이디가 발행되는 과정</p>
</blockquote>
<ol>
<li>SessionIdFilter
해당 필터에서는 사용자의 요청마다 세션 쿠키가 존재하는지 확인하고, 만약 존재하지 않을 때에는 ID Generator를 통해 세션 아이디를 생성하고 쿠키에 저장한다.</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">SessionIdFilter</span> <span style="color:#66d9ef">extends</span> OncePerRequestFilter {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> ThreadLocal<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">&gt;</span> sessionIdHolder <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ThreadLocal<span style="color:#f92672">&lt;&gt;</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> String SESSION_KEY <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;JSESSIONID&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">doFilterInternal</span>(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain) <span style="color:#66d9ef">throws</span> ServletException, IOException {
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        String sessionId <span style="color:#f92672">=</span> CookieUtils.<span style="color:#a6e22e">getCookieValue</span>(request, SESSION_KEY); <span style="color:#75715e">// 쿠키에서 세션 아이디를 조회합니다.</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (Strings.<span style="color:#a6e22e">isBlank</span>(sessionId)) { <span style="color:#75715e">// 세션 아이디가 존재하지 않는 경우 새로운 세션 아이디를 생성합니다.</span>
</span></span><span style="display:flex;"><span>            sessionIdHolder.<span style="color:#a6e22e">set</span>(SessionIdGenerator.<span style="color:#a6e22e">generate</span>());
</span></span><span style="display:flex;"><span>            CookeUtils.<span style="color:#a6e22e">addCookie</span>(response, SESSION_KEY);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        sessionIdHolder.<span style="color:#a6e22e">set</span>(sessionId); <span style="color:#75715e">// 세션 아이디를 ThreadLocal에 저장합니다.</span>
</span></span><span style="display:flex;"><span>        filterChain.<span style="color:#a6e22e">doFilter</span>(request, response); <span style="color:#75715e">// 다음 필터로 요청을 전달합니다.</span>
</span></span><span style="display:flex;"><span>        sessionIdHolder.<span style="color:#a6e22e">remove</span>(); <span style="color:#75715e">// ThreadLocal에 저장된 세션 아이디를 제거합니다.</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><ol start="2">
<li>CustomSecurityContextRepository
Spring Security에서 기본적으로는 HttpSession을 사용하여 SecurityContext를 저장하고 로드한다.
다른 세션 저장소를 사용하기 위해 SecurityContextRepository를 구현한 클래스이다.
SessionAdapter를 통해 세션 모듈에서 세션 정보 가져오고, SecurityContext를 생성하여 반환한다.</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">CustomSecurityContextRepository</span> <span style="color:#66d9ef">implements</span> SecurityContextRepository {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">final</span> SessionAdapter sessionAdapter; <span style="color:#75715e">// 세션 서버와 통신하기 위한 SessionAdapter</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">ZumContextRepository</span>(SessionAdapter sessionAdapter) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">sessionAdapter</span> <span style="color:#f92672">=</span> SessionAdapter;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> SecurityContext <span style="color:#a6e22e">loadContext</span>(HttpRequestResponseHolder requestResponseHolder) { <span style="color:#75715e">// 세션 아이디를 통해 세션 정보를 조회합니다.</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> SessionAdapter.<span style="color:#a6e22e">getSession</span>()
</span></span><span style="display:flex;"><span>            .<span style="color:#a6e22e">map</span>(<span style="color:#66d9ef">this</span>::createSecurityContext)
</span></span><span style="display:flex;"><span>            .<span style="color:#a6e22e">orElseGet</span>(<span style="color:#66d9ef">this</span>::emptyContext);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> SecurityContext <span style="color:#a6e22e">createSecurityContext</span>(<span style="color:#66d9ef">final</span> User user) { <span style="color:#75715e">// 세션 정보를 통해 SecurityContext를 생성합니다.</span>
</span></span><span style="display:flex;"><span>        UsernamePasswordAuthenticationToken usernamePasswordAuthenticationToken <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">new</span> UsernamePasswordAuthenticationToken(user, user.<span style="color:#a6e22e">getAuthorities</span>());
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> SecurityContextImpl(usernamePasswordAuthenticationToken);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> SecurityContext <span style="color:#a6e22e">emptyContext</span>() { <span style="color:#75715e">// 세션 정보가 존재하지 않는 경우 빈 SecurityContext를 생성합니다.</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> SecurityContextHolder.<span style="color:#a6e22e">createEmptyContext</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><ol start="3">
<li>SpringSecurityConfiguration
Spring Security 설정 클래스다.
SecurityContextPersistenceFilter는 SecurityContextRepository를 사용하여 SecurityContext의 저장 및 로드를 처리한다.
SecurityContextPersistenceFilter 이전에 실행되며, CustomSecurityContextRepository를 SecurityContextRepository로 설정한다.</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@EnableWebSecurity</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">SpringSecurityConfiguration</span> <span style="color:#66d9ef">extends</span> WebSecurityConfigurerAdapter {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">final</span> SessionAdapter sessionAdapter;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">SecurityConfig</span>(SessionAdapter sessionAdapter) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">sessionAdapter</span> <span style="color:#f92672">=</span> SessionAdapter;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">configure</span>(HttpSecurity http) <span style="color:#66d9ef">throws</span> Exception {
</span></span><span style="display:flex;"><span>        http.<span style="color:#a6e22e">authorizeRequests</span>()
</span></span><span style="display:flex;"><span>            .<span style="color:#a6e22e">and</span>()
</span></span><span style="display:flex;"><span>            .<span style="color:#a6e22e">securityContext</span>() <span style="color:#75715e">// SecurityContext를 설정합니다.</span>
</span></span><span style="display:flex;"><span>            .<span style="color:#a6e22e">securityContextRepository</span>(<span style="color:#66d9ef">new</span> CustomSecurityContextRepository(SessionAdapter)) <span style="color:#75715e">// SecurityContextRepository를 설정합니다.</span>
</span></span><span style="display:flex;"><span>            .<span style="color:#a6e22e">and</span>()
</span></span><span style="display:flex;"><span>            .<span style="color:#a6e22e">addFilterBefore</span>(<span style="color:#66d9ef">new</span> SessionIdFilter(), SecurityContextPersistenceFilter.<span style="color:#a6e22e">class</span>); <span style="color:#75715e">// SessionIdFilter를 SecurityContextPersistenceFilter 이전에 실행합니다.</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><blockquote>
<p>TO-BE</p>
</blockquote>
<ol>
<li>SessionAdapter</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">SessionAdapter</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">@Cacheable</span>(value <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;session&#34;</span>, key <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;#sessionId&#34;</span>)
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">public</span> ZumSessionDto <span style="color:#a6e22e">getSession</span>(String sessionId) {
</span></span><span style="display:flex;"><span>    ResponseEntity<span style="color:#f92672">&lt;</span>User<span style="color:#f92672">&gt;</span> response <span style="color:#f92672">=</span> restTemplate.<span style="color:#a6e22e">exchange</span>(
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;http://localhost:8080/api/v2/session&#34;</span>,
</span></span><span style="display:flex;"><span>            HttpMethod.<span style="color:#a6e22e">GET</span>,
</span></span><span style="display:flex;"><span>            createRequestEntityWithHttpHeader(sessionId),
</span></span><span style="display:flex;"><span>            User.<span style="color:#a6e22e">class</span>); <span style="color:#75715e">// 세션 서버에서 세션 정보를 조회합니다.</span>
</span></span><span style="display:flex;"><span>    String responseSessionId <span style="color:#f92672">=</span> getSessionIdFromResponseHeaders(response.<span style="color:#a6e22e">getHeaders</span>()); <span style="color:#75715e">// 세션 서버에서 응답받은 세션 ID를 가져옵니다.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> ZumSessionDto.<span style="color:#a6e22e">of</span>(response.<span style="color:#a6e22e">getBody</span>(), responseSessionId); <span style="color:#75715e">// 세션 정보를 Dto 변환합니다.</span>
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">private</span> String <span style="color:#a6e22e">getSessionIdFromResponseHeaders</span>(HttpHeaders headers) {
</span></span><span style="display:flex;"><span>    String cookie <span style="color:#f92672">=</span> headers.<span style="color:#a6e22e">getFirst</span>(<span style="color:#e6db74">&#34;X-SESSION-ID&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (Strings.<span style="color:#a6e22e">isNotBlank</span>(cookie)) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> cookie;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">null</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">private</span> HttpEntity<span style="color:#f92672">&lt;</span>Object<span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">createRequestEntityWithHttpHeader</span>(String sessionId) {
</span></span><span style="display:flex;"><span>    HttpHeaders requestHeaders <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> HttpHeaders();
</span></span><span style="display:flex;"><span>    requestHeaders.<span style="color:#a6e22e">add</span>(<span style="color:#e6db74">&#34;X-Session-ID&#34;</span>, sessionId);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> HttpEntity<span style="color:#f92672">&lt;&gt;</span>(<span style="color:#66d9ef">null</span>, requestHeaders);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>SessionAdapter는 각 모듈에서 세션 서버에 요청하기 위해 존재하는 Adapter이다.
기존 아키텍처는 세션 정보를 조회하기 위해 매번 네트워크 I/O 비용이 발생하는 문제가 있었다.
여러 가지 방법을 고민해보았지만, 세션 서버 요청의 90% 이상이 GET 요청으로 이루어지고 있어, 캐싱 시스템을 도입하여 세션 정보를 조회하는 비용을 줄이기로 했다.

  <img src="/image/redis/008/img_5.png" alt="img_5.png" /></p>
<p>Look-aside 전략은 캐시 시스템에서 사용되는 하나의 전략으로, 데이터를 캐시에 저장하고 검색할 때 데이터베이스 또는 백엔드 시스템에 대한 추가 작업을 최소화하는 것을 목표로 한다.</p>
<h4 id="look-aside-전략">
  Look-aside 전략
  <a class="anchor" href="#look-aside-%ec%a0%84%eb%9e%b5">#</a>
</h4>
<ol>
<li>데이터를 읽거나 검색하기 전에, 먼저 캐시에서 데이터를 찾는다.</li>
<li>데이터가 캐시에 존재하면, 해당 데이터를 반환하고 추가적인 백엔드 작업을 수행하지 않는다.</li>
<li>데이터가 캐시에 존재하지 않으면, 데이터를 백엔드 시스템에서 검색한 후, 해당 데이터를 캐시에 저장하고 반환한다.</li>
<li>이후 같은 데이터에 대한 요청이 들어올 때는 캐시에서 데이터를 반환한다.</li>
</ol>
<p>이러한 방식으로 Look-aside 전략은 세션 서버에 대한 요청을 최소화하고, 데이터를 빠르게 반환하여 성능을 향상시킬 수 있다.
만약 데이터의 업데이트가 발생하면, @CacheEvict를 통해 캐시를 업데이트 하도록 구현했다.
세션 정보가 필요할 때 마다 네트워크 I/O 비용이 발생하는 문제는 캐싱 시스템을 도입함으로써 해결하였으며 캐시 정합성 문제는 @CachePut를 통해 해결했다.</p>
<p>코드를 보면 특이하게도 세션 서버에 요청할 때 세션 아이디를 쿠키가 아닌 헤더에 담아 요청하고 응답을 받고있다.
아래 사진처럼 Spring Session은 세션 아이디를 기본적으로 쿠키를 통해 발행하도록 구현되어 있지만 세션 아이디를 헤더에 담아서 요청과 응답을 하는 것이 현재 아키텍처에서 더욱 적합하다고 생각했다.

  <img src="/image/redis/008/img_6.png" alt="img_6.png" /></p>
<p>이유는 아래와 같다.</p>
<ol>
<li>Set-Cookie 헤더는 브라우저가 응답받고 쿠키를 저장하는 과정을 거치기 때문에 브라우저가 없는 서버 간 요청에서는 쿠키를 저장할 수 없습니다.</li>
<li>쿠키는 클라이언트 보안 정책에 따라 다르지만, 기본적으로 같은 도메인 간에만 공유된다. 하지만 헤더는 타사 도메인 간 요청에서 커스텀 헤더를 통해 데이터를 전달할 수 있다. 이는 추후 줌인터넷에서 제공하는 서비스가 만약 다른 도메인을 가질 때 유연하게 대응할 수 있다고 판단했다.</li>
</ol>
<p>따라서 세션 아이디를 헤더에 발행하는 방법으로 Spring Session을 커스터마이징하여 구현하였다.</p>
<ol start="2">
<li>CustomSessionIdResolver</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.session.web.http.HeaderHttpSessionIdResolver;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> javax.servlet.http.HttpServletRequest;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> javax.servlet.http.HttpServletResponse;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> java.util.List;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">CustomSessionIdResolver</span> <span style="color:#66d9ef">extends</span> HeaderHttpSessionIdResolver {
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">CustomSessionIdResolver</span>(String headerName) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">super</span>(headerName);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> List<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">resolveSessionIds</span>(HttpServletRequest request) {
</span></span><span style="display:flex;"><span>        List<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">&gt;</span> sessionIds <span style="color:#f92672">=</span> <span style="color:#66d9ef">super</span>.<span style="color:#a6e22e">resolveSessionIds</span>(request);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (sessionIds.<span style="color:#a6e22e">isEmpty</span>()) {
</span></span><span style="display:flex;"><span>            String sessionId <span style="color:#f92672">=</span> request.<span style="color:#a6e22e">getHeader</span>(<span style="color:#e6db74">&#34;X-Session-ID&#34;</span>); <span style="color:#75715e">// 헤더에서 세션 아이디를 읽어옵니다.</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (sessionId <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span>) {
</span></span><span style="display:flex;"><span>                sessionIds.<span style="color:#a6e22e">add</span>(sessionId);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> sessionIds;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">setSessionId</span>(HttpServletRequest request, HttpServletResponse response, String sessionId) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">super</span>.<span style="color:#a6e22e">setSessionId</span>(request, response, sessionId);
</span></span><span style="display:flex;"><span>        response.<span style="color:#a6e22e">setHeader</span>(HEADER_SESSION_ID, sessionId); <span style="color:#75715e">// 헤더에 세션 아이디를 추가합니다.</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>HeaderHttpSessionIdResolver 클래스는 Spring Session에서 제공하는 HttpSessionIdResolver 인터페이스의 구현체다.
이 클래스를 사용하면 세션 아이디를 HTTP 헤더에 포함하여 전달할 수 있다.
해당 클래스의 생성자는 세션 아이디를 담을 헤더의 이름을 인자로 받을 수 있다.</p>
<ol start="3">
<li>HttpSessionIdResolverConfiguration</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.context.annotation.Bean;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.context.annotation.Configuration;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.session.data.redis.config.annotation.web.http.EnableRedisHttpSession;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.session.web.http.HttpSessionIdResolver;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@Configuration</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">HttpSessionIdResolverConfiguration</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Bean</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> HttpSessionIdResolver <span style="color:#a6e22e">httpSessionIdResolver</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> CustomSessionIdResolver(<span style="color:#e6db74">&#34;X-Session-ID&#34;</span>); <span style="color:#75715e">// 세션 아이디를 담을 헤더 이름을 지정합니다.</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>위의 코드를 통해 CustomSessionIdResolver 클래스가 Bean으로 등록된다.</p>
<ol start="4">
<li>SessionController</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@RestController</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@RequestMapping</span>(<span style="color:#e6db74">&#34;/api/v2/session&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">SessionController</span> {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">final</span> ObjectMapper objectMapper;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">SessionController</span>(ObjectMapper objectMapper) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">objectMapper</span> <span style="color:#f92672">=</span> objectMapper;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@GetMapping</span>
</span></span><span style="display:flex;"><span>    User <span style="color:#a6e22e">session</span>(HttpSession httpSession) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> objectMapper.<span style="color:#a6e22e">convertValue</span>(httpSession.<span style="color:#a6e22e">getAttribute</span>(<span style="color:#e6db74">&#34;user&#34;</span>), User.<span style="color:#a6e22e">class</span>); <span style="color:#75715e">// 세션에서 user attribute를 꺼내서 응답합니다.</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>세션 서버의 역할은 간단하다.
SessionController 에서는 각 모듈에서 요청한 attribute를 세션에서 꺼내서 응답한다.
Spring Session을 적용하였기 때문에 기존의 HttpSession 객체는 Spring Session이 제공하는 세션 객체로 대체되며, 데이터는 Redis에 저장되고 관리된다.</p>
<h2 id="마무리---확인">
  마무리 - 확인
  <a class="anchor" href="#%eb%a7%88%eb%ac%b4%eb%a6%ac---%ed%99%95%ec%9d%b8">#</a>
</h2>
<p>세션 정보를 조회하는 별도의 모듈이 존재하고 각 서비스는 특정 모듈을 통해 세션 정보를 조회하도록 API를 제공하고 있지만, 세션 서버를 직접 호출하는 서비스가 존재할 수 있어서 이를 확인해야 했다.
아니나 다를까 우려했던 것처럼 세션 서버를 직접 호출하는 서비스가 존재했다.
회원 서비스는 전사 서비스이기 때문에 다른 서비스에 장애 전파가 발생하지 않도록 특히 주의해야한다.
기존 서비스의 수정 없이 세션 서버에서 대응할 수 있는 방법을 찾아야 했고, Nginx를 통해 세션 서버로의 요청을 가로챈 후 헤더에 세션 아이디를 담아서 요청을 보내는 방법을 선택했다.</p>
<blockquote>
<p>nginx.conf</p>
</blockquote>
<pre tabindex="0"><code>http { 
    server {
        listen 80;
        server_name example.com;

        location /api/v1/session {  # 특정 URL로 요청이 들어오면
            set $session_id &#34;&#34;; # 세션 아이디를 담을 변수를 선언합니다.
            if ($args ~* &#34;(?:^|&amp;)JSESSIONID=([^&amp;]+)&#34;) { # URL에 세션 아이디가 담겨있다면
                set $session_id $1; # 세션 아이디를 변수에 담습니다.
            }

            proxy_set_header X-Session-ID $session_id; # 세션 아이디를 헤더에 담습니다.
            proxy_pass http://backend;
            # 나머지 프록시 설정
        }
        # 나머지 서버 설정
    }
</code></pre><p>결과적으로, 서비스에 장애가 전파되지 않도록 기존에 사용하던 /api/v1/session 엔드포인트를 유지하면서 세션 저장소를 성공적으로 교체할 수 있었다.</p>
<hr>




<div class="book-tabs"><input type="radio" class="toggle" name="tabs-References" id="tabs-References-0" checked="checked" />
  <label for="tabs-References-0">References</label>
  <div class="book-tabs-content markdown-inner"><ol>
<li>
  <a href="https://zuminternet.github.io/spring-session/">https://zuminternet.github.io/spring-session/</a></li>
</ol>
</div></div>

</article>
 
      

      <footer class="book-footer">
        
  <div class="flex flex-wrap justify-between">


  <div><a class="flex align-center" href="https://github.com/seohaebada/TIL/commit/467cc73d5c6b75e92913e930fff07301c13cb387" title='Last modified by seohaebada | December 26, 2023' target="_blank" rel="noopener">
      <img src="/svg/calendar.svg" class="book-icon" alt="Calendar" />
      <span>December 26, 2023</span>
    </a>
  </div>



  <div>
    <a class="flex align-center" href="https://github.com/seohaebada/TIL/content/docs/content/docs/redis/008_spring_session_redis.md" target="_blank" rel="noopener">
      <img src="/svg/edit.svg" class="book-icon" alt="Edit" />
      <span>Edit this page</span>
    </a>
  </div>


</div>



  <script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script>


 
        
      </footer>

      
  
  <div class="book-comments">

</div>
  
 

      <label for="menu-control" class="hidden book-menu-overlay"></label>
    </div>

    
    <aside class="book-toc">
      <div class="book-toc-content">
        
  
<nav id="TableOfContents">
  <ul>
    <li><a href="#tech-blog-글-읽고-정리하기"><code>tech blog 글 읽고 정리하기</code></a></li>
    <li><a href="#제목은-spring-session-도입기로-하겠습니다-근데-이제-redis를-곁들인">제목은 Spring Session 도입기로 하겠습니다. 근데 이제 Redis를 곁들인</a>
      <ul>
        <li><a href="#개요">개요</a></li>
        <li><a href="#도입-배경">도입 배경</a></li>
        <li><a href="#spring-session">Spring Session</a></li>
        <li><a href="#spring-session-적용-예시">Spring Session 적용 예시</a></li>
        <li><a href="#아키텍처">아키텍처</a></li>
        <li><a href="#코드로-살펴보는-개선-과정">코드로 살펴보는 개선 과정</a>
          <ul>
            <li></li>
          </ul>
        </li>
        <li><a href="#마무리---확인">마무리 - 확인</a></li>
      </ul>
    </li>
  </ul>
</nav>


 
      </div>
    </aside>
    
  </main>

  
</body>
</html>












